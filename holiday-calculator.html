<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holiday Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        input[type="number"] {
            -moz-appearance: textfield;
            appearance: textfield;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* Responsive tweaks for calendar navigation and day cells */
        @media (max-width: 640px) {
            /* Make nav buttons compact and circular on small screens */
            .nav-btn {
                width: 40px;
                height: 40px;
                padding: 0;
                border-radius: 9999px; /* full */
                display: inline-flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            }

            /* Show only arrow on very small screens; full text remains on sm+ (handled in markup) */
            #currentMonth {
                font-size: 1.125rem; /* text-lg */
            }

            /* Slightly tighter grid spacing so day cells remain usable */
            #calendar {
                gap: 6px;
            }

            /* Make calendar day cells slightly smaller text and better touch target */
            .calendar-day {
                font-size: 0.9rem;
                border-width: 1px;
                padding: 6px;
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <header class="bg-white shadow-md mb-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex-shrink-0">
                    <a href="index.html" class="text-2xl font-bold text-gray-800">Alex's Helpful Tools</a>
                </div>
            </div>
        </div>
    </header>

    <main class="w-full max-w-7xl mx-auto bg-white rounded-xl shadow-2xl p-6 md:p-10">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">
            Holiday Planner
        </h1>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div class="lg:col-span-1 space-y-6">
                <div class="p-6 bg-gray-50 rounded-lg border">
                    <h2 class="text-xl font-semibold text-gray-700 border-b border-gray-200 pb-2 mb-4">Settings</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label for="holidayAllowance" class="block text-sm font-medium text-gray-600 mb-1">Holiday Allowance (days)</label>
                            <input type="number" id="holidayAllowance" value="25" min="0" max="365" 
                                   class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <div>
                            <label for="startDate" class="block text-sm font-medium text-gray-600 mb-1">Start Date</label>
                            <input type="date" id="startDate" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <div>
                            <label for="endDate" class="block text-sm font-medium text-gray-600 mb-1">End Date</label>
                            <input type="date" id="endDate" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <div class="pt-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="showBankHolidays" checked class="mr-2 h-4 w-4 text-blue-600 rounded">
                                <span class="text-sm font-medium text-gray-700">Show UK Bank Holidays</span>
                            </label>
                        </div>
                        <div class="pt-2">
                            <button id="clearSaved" class="w-full px-3 py-2 bg-white border border-red-200 text-red-600 rounded-lg hover:bg-red-50">Clear saved data</button>
                        </div>
                    </div>
                </div>

                <div class="p-6 bg-gray-50 rounded-lg border">
                    <h2 class="text-xl font-semibold text-gray-700 border-b border-gray-200 pb-2 mb-4">Summary</h2>
                    <div class="space-y-3">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Total Allowance</p>
                            <p id="totalAllowance" class="text-2xl font-bold text-gray-800">0 days</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-600">Planned</p>
                            <p id="plannedDays" class="text-2xl font-bold text-blue-600">0 days</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-600">Remaining</p>
                            <p id="remainingDays" class="text-2xl font-bold text-green-600">0 days</p>
                        </div>
                    </div>
                </div>

                <div class="p-6 bg-gray-50 rounded-lg border">
                    <h2 class="text-xl font-semibold text-gray-700 border-b border-gray-200 pb-2 mb-4">Legend</h2>
                    <div class="space-y-3 text-sm">
                        <div class="flex items-center">
                            <div class="w-6 h-6 bg-blue-500 rounded mr-3"></div>
                            <span class="text-gray-700">Planned Holiday</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-6 h-6 bg-green-100 border-2 border-green-500 rounded mr-3"></div>
                            <span class="text-gray-700">Bank Holiday</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-6 h-6 bg-gray-200 rounded mr-3"></div>
                            <span class="text-gray-700">Weekend</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-3">
                <div class="p-6 bg-gray-50 rounded-lg border">
                    <div class="flex justify-between items-center mb-6 gap-4">
                        <button id="prevMonth" class="nav-btn px-0 sm:px-4 py-2 bg-white border border-gray-300 rounded-full sm:rounded-lg hover:bg-gray-100 transition font-medium text-gray-700 shadow-sm" aria-label="Previous month">
                            <span class="inline sm:hidden text-base">←</span>
                            <span class="hidden sm:inline">← Previous</span>
                        </button>
                        <h2 id="currentMonth" class="text-lg sm:text-2xl font-bold text-gray-800 text-center flex-1"></h2>
                        <button id="nextMonth" class="nav-btn px-0 sm:px-4 py-2 bg-white border border-gray-300 rounded-full sm:rounded-lg hover:bg-gray-100 transition font-medium text-gray-700 shadow-sm" aria-label="Next month">
                            <span class="inline sm:hidden text-base">→</span>
                            <span class="hidden sm:inline">Next →</span>
                        </button>
                    </div>
                    <div id="calendar" class="grid grid-cols-7 gap-2"></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const state = {
            currentDate: new Date(),
            startDate: null,
            endDate: null,
            holidayAllowance: 25,
            plannedHolidays: new Set(),
            bankHolidays: [],
            showBankHolidays: true
        };

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function initializeDateInputs() {
            const now = new Date();
            const startOfYear = new Date(now.getFullYear(), 0, 1);
            const endOfYear = new Date(now.getFullYear(), 11, 31);

            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');

            // Ensure the inputs cannot pick dates outside the current year
            startDateInput.min = formatDate(startOfYear);
            startDateInput.max = formatDate(endOfYear);
            endDateInput.min = formatDate(startOfYear);
            endDateInput.max = formatDate(endOfYear);

            // Default values: use start of year and end of year (user can change)
            startDateInput.valueAsDate = startOfYear;
            endDateInput.valueAsDate = endOfYear;

            state.startDate = startOfYear;
            state.endDate = endOfYear;
            state.currentDate = new Date(startOfYear);
        }

        async function fetchBankHolidays() {
            try {
                const response = await fetch('https://www.gov.uk/bank-holidays.json');
                const data = await response.json();

                const holidays = data['england-and-wales'].events.map(event => ({
                    date: new Date(event.date + 'T00:00:00'),
                    title: event.title
                }));

                state.bankHolidays = holidays;
                return holidays;
            } catch (error) {
                console.error('Failed to fetch bank holidays:', error);
                return [];
            }
        }

        function isBankHoliday(date) {
            if (!state.showBankHolidays) return null;
            const dateStr = formatDate(date);
            return state.bankHolidays.find(bh => formatDate(bh.date) === dateStr);
        }

        function isWeekend(date) {
            const day = date.getDay();
            return day === 0 || day === 6;
        }

        function isPlannedHoliday(date) {
            return state.plannedHolidays.has(formatDate(date));
        }

        function toggleHoliday(date) {
            const dateStr = formatDate(date);
            if (isWeekend(date) || (isBankHoliday(date) && !isPlannedHoliday(date))) {
                return;
            }

            if (state.plannedHolidays.has(dateStr)) {
                state.plannedHolidays.delete(dateStr);
            } else {
                state.plannedHolidays.add(dateStr);
            }

            renderCalendar();
            updateSummary();
            saveStateToStorage();
        }

        function renderCalendar() {
            const calendar = document.getElementById('calendar');
            calendar.innerHTML = '';

            const year = state.currentDate.getFullYear();
            const month = state.currentDate.getMonth();

            document.getElementById('currentMonth').textContent =
                state.currentDate.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });

            const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            dayNames.forEach(day => {
                const header = document.createElement('div');
                header.className = 'text-center font-semibold text-gray-700 py-3 text-sm';
                header.textContent = day;
                calendar.appendChild(header);
            });

            const firstDay = new Date(year, month, 1);
            let dayOffset = firstDay.getDay() - 1;
            if (dayOffset === -1) dayOffset = 6;

            for (let i = 0; i < dayOffset; i++) {
                calendar.appendChild(document.createElement('div'));
            }

            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const cell = createDayCell(date);
                calendar.appendChild(cell);
            }
        }

        function createDayCell(date) {
            const cell = document.createElement('div');
            const isWeekendDay = isWeekend(date);
            const bankHoliday = isBankHoliday(date);
            const isPlanned = isPlannedHoliday(date);

            // Compare only the date parts (YYYY-MM-DD) to avoid timezone/time component issues
            let isInRange = true;
            if (state.startDate && state.endDate) {
                const d = formatDate(date);
                isInRange = d >= formatDate(state.startDate) && d <= formatDate(state.endDate);
            }

            cell.className = 'calendar-day aspect-square flex flex-col items-center justify-center text-sm border-2 rounded-lg cursor-pointer transition-all duration-200 relative';

            if (!isInRange) {
                cell.className += ' bg-gray-100 border-gray-200 text-gray-400 cursor-not-allowed';
            } else if (isPlanned) {
                cell.className += ' bg-blue-500 border-blue-600 text-white hover:bg-blue-600 shadow-md';
            } else if (bankHoliday) {
                cell.className += ' bg-green-100 border-green-500 text-green-800 cursor-default';
            } else if (isWeekendDay) {
                cell.className += ' bg-gray-200 border-gray-300 text-gray-600 cursor-default';
            } else {
                cell.className += ' bg-white border-gray-300 hover:bg-blue-50 hover:border-blue-400 shadow-sm';
            }

            const dayNumber = document.createElement('div');
            dayNumber.className = 'font-semibold text-base';
            dayNumber.textContent = date.getDate();
            cell.appendChild(dayNumber);

            if (bankHoliday) {
                const indicator = document.createElement('div');
                indicator.className = 'text-xs font-bold mt-1';
                indicator.textContent = 'BH';
                indicator.title = bankHoliday.title;
                cell.appendChild(indicator);
            }

            if (isInRange) {
                cell.addEventListener('click', () => toggleHoliday(date));
            }

            return cell;
        }

        function previousMonth() {
            state.currentDate.setMonth(state.currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            state.currentDate.setMonth(state.currentDate.getMonth() + 1);
            renderCalendar();
        }

        function updateSummary() {
            document.getElementById('totalAllowance').textContent = state.holidayAllowance + ' days';
            document.getElementById('plannedDays').textContent = state.plannedHolidays.size + ' days';
            document.getElementById('remainingDays').textContent = (state.holidayAllowance - state.plannedHolidays.size) + ' days';
        }

        // Persist app state to localStorage (only simple, serializable fields)
        function saveStateToStorage() {
            try {
                const payload = {
                    startDate: state.startDate ? formatDate(state.startDate) : null,
                    endDate: state.endDate ? formatDate(state.endDate) : null,
                    holidayAllowance: state.holidayAllowance,
                    plannedHolidays: Array.from(state.plannedHolidays),
                    showBankHolidays: state.showBankHolidays,
                    currentDate: state.currentDate ? formatDate(state.currentDate) : null
                };
                localStorage.setItem('holidayPlannerState', JSON.stringify(payload));
            } catch (e) {
                console.error('Failed to save state:', e);
            }
        }

        function loadStateFromStorage() {
            try {
                const raw = localStorage.getItem('holidayPlannerState');
                if (!raw) return false;
                const p = JSON.parse(raw);

                if (p.holidayAllowance != null) {
                    state.holidayAllowance = p.holidayAllowance;
                    document.getElementById('holidayAllowance').value = p.holidayAllowance;
                }

                if (p.startDate) {
                    document.getElementById('startDate').value = p.startDate;
                    state.startDate = new Date(p.startDate + 'T00:00:00');
                }

                if (p.endDate) {
                    document.getElementById('endDate').value = p.endDate;
                    state.endDate = new Date(p.endDate + 'T00:00:00');
                }

                if (Array.isArray(p.plannedHolidays)) {
                    state.plannedHolidays = new Set(p.plannedHolidays);
                }

                if (typeof p.showBankHolidays === 'boolean') {
                    state.showBankHolidays = p.showBankHolidays;
                    document.getElementById('showBankHolidays').checked = p.showBankHolidays;
                }

                if (p.currentDate) {
                    state.currentDate = new Date(p.currentDate + 'T00:00:00');
                }

                // Ensure endDate input min reflects loaded start
                if (state.startDate) {
                    document.getElementById('endDate').min = formatDate(state.startDate);
                }

                return true;
            } catch (e) {
                console.error('Failed to load saved state:', e);
                return false;
            }
        }

        function clearSavedState() {
            localStorage.removeItem('holidayPlannerState');
            // Reset UI + state to defaults
            state.plannedHolidays = new Set();
            state.holidayAllowance = 25;
            document.getElementById('holidayAllowance').value = 25;
            document.getElementById('showBankHolidays').checked = true;
            state.showBankHolidays = true;
            initializeDateInputs();
            renderCalendar();
            updateSummary();
        }

        function updateSettings() {
            const allowance = parseInt(document.getElementById('holidayAllowance').value);
            const startDate = document.getElementById('startDate').valueAsDate;
            const endDate = document.getElementById('endDate').valueAsDate;
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');

            // Keep the endDate input min equal to the selected startDate so users can't pick an earlier end
            if (startDate) {
                endDateInput.min = formatDate(startDate);
                state.startDate = startDate;
            } else {
                const now = new Date();
                endDateInput.min = formatDate(new Date(now.getFullYear(), 0, 1));
            }

            if (endDate) {
                if (state.startDate && formatDate(endDate) < formatDate(state.startDate)) {
                    endDateInput.valueAsDate = state.startDate;
                    state.endDate = state.startDate;
                } else {
                    state.endDate = endDate;
                }
            }

            if (state.startDate) state.currentDate = new Date(state.startDate);

            state.holidayAllowance = allowance;
            renderCalendar();
            updateSummary();
            saveStateToStorage();
        }

        // Wire up event listeners
        document.getElementById('prevMonth').addEventListener('click', previousMonth);
        document.getElementById('nextMonth').addEventListener('click', nextMonth);

        document.getElementById('holidayAllowance').addEventListener('change', updateSettings);
        document.getElementById('startDate').addEventListener('change', updateSettings);
        document.getElementById('endDate').addEventListener('change', updateSettings);

        document.getElementById('showBankHolidays').addEventListener('change', () => {
            state.showBankHolidays = document.getElementById('showBankHolidays').checked;
            renderCalendar();
            saveStateToStorage();
        });

        document.getElementById('clearSaved').addEventListener('click', () => {
            clearSavedState();
        });

        async function init() {
            initializeDateInputs();
            await fetchBankHolidays();
            // Load persisted state (if any) after bank holidays are available
            loadStateFromStorage();
            renderCalendar();
            updateSummary();
        }

        init();
    </script>
</body>
</html>