<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alex's Pension Calculator</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Remove input spinner */
        input[type="number"] { -moz-appearance: textfield; appearance: textfield; }
        input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        /* Scrollbar styling */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        /* Chart container responsiveness */
        .chart-container { position: relative; height: 300px; width: 100%; }
        @media (min-width: 768px) { .chart-container { height: 100%; } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 flex flex-col h-screen">

    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 flex-shrink-0 z-30 relative">
        <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-14">
                <div class="flex items-center gap-2">
                    <a href="index.html" class="flex items-center gap-2 hover:opacity-80 transition">
                        <div class="bg-blue-600 text-white p-1.5 rounded-lg">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                        </div>
                        <span class="text-lg font-bold text-gray-900 tracking-tight">Alex's <span class="text-blue-600">Pension Calculator</span></span>
                    </a>
                </div>
                <!-- Mobile Menu Button -->
                <button id="mobileMenuBtn" class="md:hidden p-2 text-gray-600 hover:text-blue-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
                </button>
                <div class="hidden md:block text-xs font-medium text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                    Real-Terms (Net Spendable Power)
                </div>
            </div>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="flex-1 flex flex-col md:flex-row relative">
        
        <!-- Sidebar: Configuration -->
        <aside id="sidebar" class="absolute md:static inset-0 z-20 bg-white transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col w-full md:w-[400px] lg:w-[450px] border-r border-gray-200 shadow-xl md:shadow-none">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center md:hidden bg-gray-50">
                <span class="font-bold text-gray-700">Configuration</span>
                <button id="closeSidebar" class="text-gray-500 p-1">✕ Close</button>
            </div>

            <div class="flex-1 overflow-y-auto custom-scroll p-5 space-y-6">
                
                <!-- Personal Settings -->
                <section class="space-y-4">
                    <h2 class="text-sm font-bold text-gray-900 uppercase tracking-wider flex items-center gap-2">
                        <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                        Personal
                    </h2>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="group">
                            <label class="block text-xs font-medium text-gray-500 mb-1">Current Age</label>
                            <input type="number" id="currentAge" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-md text-sm font-semibold focus:ring-2 focus:ring-blue-500 outline-none transition">
                        </div>
                        <div class="group">
                            <label class="block text-xs font-medium text-gray-500 mb-1">Retirement Age</label>
                            <input type="number" id="retireAge" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-md text-sm font-semibold focus:ring-2 focus:ring-blue-500 outline-none transition">
                        </div>
                        <div class="group">
                            <label class="block text-xs font-medium text-gray-500 mb-1">Life Expectancy</label>
                            <input type="number" id="lifeExpectancy" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-md text-sm font-semibold focus:ring-2 focus:ring-blue-500 outline-none transition">
                        </div>
                         <div class="group">
                            <label class="block text-xs font-medium text-gray-500 mb-1">Target <span class="text-blue-600">Net</span> Income</label>
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-gray-400 text-sm">£</span>
                                <input type="number" id="targetIncome" class="w-full pl-6 p-2 bg-gray-50 border border-gray-200 rounded-md text-sm font-semibold focus:ring-2 focus:ring-blue-500 outline-none transition" step="500">
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                         <div class="flex justify-between items-center mb-1">
                            <label class="text-xs font-medium text-gray-600">Inflation Rate</label>
                            <input type="number" id="inflationRate" step="0.1" class="w-16 text-right text-xs p-1 border border-gray-300 rounded bg-white">
                        </div>
                        <p class="text-[10px] text-gray-400">Calculations use Real Growth (Nominal - Inflation).</p>
                    </div>
                </section>

                <hr class="border-gray-100">

                <!-- Tax Settings -->
                <section class="space-y-4">
                    <h2 class="text-sm font-bold text-gray-900 uppercase tracking-wider flex items-center gap-2 cursor-pointer select-none" onclick="document.getElementById('taxSettings').classList.toggle('hidden')">
                        <svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16l3.5-2 3.5 2 3.5-2 3.5 2zM10 8.5a.5.5 0 11-1 0 .5.5 0 011 0zm5 5a.5.5 0 11-1 0 .5.5 0 011 0z"/></svg>
                        Tax Configuration <span class="text-xs text-gray-400 ml-auto font-normal lowercase">(click to toggle)</span>
                    </h2>
                    
                    <div id="taxSettings" class="hidden space-y-3 bg-amber-50/50 p-3 rounded-lg border border-amber-100">
                        <p class="text-[10px] text-gray-500 mb-2">Applies to 'Pension' pots & State Pension. ISAs are treated tax-free.</p>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-[10px] text-gray-500 uppercase">Allowance (£)</label>
                                <input type="number" id="taxAllowance" class="w-full text-sm p-1 border rounded">
                            </div>
                            <div>
                                <label class="block text-[10px] text-gray-500 uppercase">Basic Rate %</label>
                                <input type="number" id="taxBasicRate" class="w-full text-sm p-1 border rounded">
                            </div>
                            <div>
                                <label class="block text-[10px] text-gray-500 uppercase">Hr Threshold (£)</label>
                                <input type="number" id="taxHigherThreshold" class="w-full text-sm p-1 border rounded">
                            </div>
                             <div>
                                <label class="block text-[10px] text-gray-500 uppercase">Higher Rate %</label>
                                <input type="number" id="taxHigherRate" class="w-full text-sm p-1 border rounded">
                            </div>
                        </div>
                        <div class="flex items-center justify-between pt-1">
                            <label class="text-[10px] text-gray-500 uppercase font-bold">Tax Free Cash</label>
                            <div class="flex items-center gap-1">
                                <input type="number" id="taxFreeCashPercent" class="w-12 text-sm p-1 border rounded text-right">
                                <span class="text-xs">%</span>
                            </div>
                        </div>
                    </div>
                </section>

                <hr class="border-gray-100">

                <!-- Pots Manager -->
                <section class="space-y-4">
                    <div class="flex flex-col gap-2">
                        <h2 class="text-sm font-bold text-gray-900 uppercase tracking-wider flex items-center gap-2 mb-1">
                            <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            Funding Sources
                        </h2>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="addPot('pension')" class="text-[10px] bg-blue-50 text-blue-700 border border-blue-200 px-2 py-1.5 rounded hover:bg-blue-100 transition font-medium text-center">+ Pension</button>
                            <button onclick="addPot('isa')" class="text-[10px] bg-purple-50 text-purple-700 border border-purple-200 px-2 py-1.5 rounded hover:bg-purple-100 transition font-medium text-center">+ S&S ISA</button>
                            <button onclick="addPot('cash')" class="text-[10px] bg-emerald-50 text-emerald-700 border border-emerald-200 px-2 py-1.5 rounded hover:bg-emerald-100 transition font-medium text-center">+ Cash</button>
                        </div>
                    </div>

                    <div id="potsContainer" class="space-y-3">
                        <!-- Pots injected via JS -->
                    </div>
                    
                    <div class="p-3 border border-gray-200 rounded-lg bg-indigo-50/50">
                        <div class="flex items-start gap-3">
                            <input type="checkbox" id="includeStatePension" checked class="mt-1 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                            <div class="flex-1">
                                <div class="flex justify-between">
                                    <label for="includeStatePension" class="text-sm font-semibold text-gray-800 cursor-pointer">UK State Pension</label>
                                    <span class="text-xs font-mono text-indigo-700">~£11,502/yr</span>
                                </div>
                                <div class="flex items-center gap-2 mt-1">
                                    <label class="text-[10px] text-gray-500">Claim Age:</label>
                                    <input type="number" id="statePensionAge" value="68" class="w-12 text-xs p-0.5 border rounded text-center bg-white">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="pt-4">
                        <button onclick="clearStorage()" class="w-full text-xs text-red-400 hover:text-red-600 underline text-center">Reset all data</button>
                    </div>
                </section>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col bg-gray-50 relative w-full">
            
            <div class="md:hidden bg-blue-50 border-b border-blue-100 px-4 py-2 text-center">
                <p class="text-xs font-medium text-blue-700">Figures in Net Real Terms (Spendable)</p>
            </div>

            <!-- KPI Cards -->
            <div class="p-4 sm:p-6 grid grid-cols-2 lg:grid-cols-4 gap-3 flex-shrink-0">
                <div class="bg-white p-3 sm:p-4 rounded-xl shadow-sm border border-gray-200">
                    <p class="text-[10px] sm:text-xs font-medium text-gray-500 uppercase truncate">Pot @ Retirement</p>
                    <h3 class="text-lg sm:text-2xl font-bold text-gray-900 mt-1 truncate" id="kpiTotalValue">£0</h3>
                </div>
                <div class="bg-white p-3 sm:p-4 rounded-xl shadow-sm border border-gray-200 relative group">
                    <p class="text-[10px] sm:text-xs font-medium text-gray-500 uppercase truncate">Earliest Possible</p>
                    <h3 class="text-lg sm:text-2xl font-bold text-indigo-600 mt-1" id="kpiEarliestAge">--</h3>
                    <p class="text-[10px] text-gray-400">Age with 0 shortfall</p>
                     <div class="absolute hidden group-hover:block top-full left-0 bg-gray-800 text-white text-xs p-2 rounded z-10 w-48 mt-1 shadow-lg">
                        The earliest age you can retire and sustain your NET target income (after tax) until your life expectancy.
                    </div>
                </div>
                <div class="bg-white p-3 sm:p-4 rounded-xl shadow-sm border border-gray-200 relative group">
                    <p class="text-[10px] sm:text-xs font-medium text-gray-500 uppercase truncate">Max Net Income</p>
                    <h3 class="text-lg sm:text-2xl font-bold text-emerald-600 mt-1 truncate" id="kpiMaxIncome">£0</h3>
                    <p class="text-[10px] text-gray-400">Annual Sustainable</p>
                     <div class="absolute hidden group-hover:block top-full left-0 bg-gray-800 text-white text-xs p-2 rounded z-10 w-48 mt-1 shadow-lg">
                        The maximum flat NET income you can draw until your life expectancy.
                    </div>
                </div>
                <div class="bg-white p-3 sm:p-4 rounded-xl shadow-sm border border-gray-200" id="kpiStatusCard">
                    <p class="text-[10px] sm:text-xs font-medium text-gray-500 uppercase truncate">Funded Until</p>
                    <h3 class="text-lg sm:text-2xl font-bold text-gray-900 mt-1 truncate" id="kpiRunOutAge">95+</h3>
                    <p class="text-[10px] text-gray-400" id="kpiStatusText">Status</p>
                </div>
            </div>

            <!-- Tabs -->
            <div class="px-4 sm:px-6 border-b border-gray-200 bg-white flex-shrink-0 overflow-x-auto hide-scrollbar">
                <nav class="-mb-px flex space-x-6 sm:space-x-8">
                    <button onclick="switchTab('wealth')" id="tab-wealth" class="tab-btn border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">Wealth</button>
                    <button onclick="switchTab('income')" id="tab-income" class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">Net Income & Tax</button>
                    <button onclick="switchTab('schedule')" id="tab-schedule" class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">Schedule</button>
                </nav>
            </div>

            <!-- Tab Contents -->
            <div class="flex-1 overflow-y-auto custom-scroll p-4 sm:p-6">
                <div id="view-wealth" class="bg-white p-2 sm:p-4 rounded-xl border border-gray-200 shadow-sm h-full flex flex-col">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2">Total Pot Value (Real Terms)</h3>
                    <div class="flex-1 min-h-[300px] relative"><canvas id="wealthChart"></canvas></div>
                </div>
                <div id="view-income" class="hidden bg-white p-2 sm:p-4 rounded-xl border border-gray-200 shadow-sm h-full flex flex-col">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2">Net Income & Tax Breakdown</h3>
                    <div class="flex-1 min-h-[300px] relative"><canvas id="incomeChart"></canvas></div>
                </div>
                <div id="view-schedule" class="hidden bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50">Age</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Wealth</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Net Target</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider text-red-600">Tax Paid</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Gross Draw</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Gap</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleBody" class="bg-white divide-y divide-gray-200 text-sm font-mono"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="sidebarOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-10 hidden md:hidden glass"></div>

    <script>
        // --- Constants ---
        const COLORS = [
            { border: '#2563EB', bg: 'rgba(37, 99, 235, 0.6)' },
            { border: '#059669', bg: 'rgba(5, 150, 105, 0.6)' },
            { border: '#7C3AED', bg: 'rgba(124, 58, 237, 0.6)' },
            { border: '#D97706', bg: 'rgba(217, 119, 6, 0.6)' },
            { border: '#DB2777', bg: 'rgba(219, 39, 119, 0.6)' }
        ];

        const defaultState = {
            currentAge: 35,
            retireAge: 60,
            lifeExpectancy: 90,
            targetIncome: 30000,
            inflationRate: 2.5,
            tax: { allowance: 12570, basicRate: 20, higherThreshold: 50270, higherRate: 40, taxFreeCashPercent: 25 },
            statePension: { active: true, amount: 11502, startAge: 68 },
            pots: [
                { id: 'p1', name: 'Workplace Pension', type: 'pension', value: 45000, monthly: 400, growth: 5, accessAge: 57, stopAge: 60 },
                { id: 'p2', name: 'S&S ISA', type: 'isa', value: 15000, monthly: 200, growth: 6, accessAge: 0, stopAge: 60 }
            ]
        };

        let state = JSON.parse(JSON.stringify(defaultState));
        let wealthChartInstance = null;
        let incomeChartInstance = null;

        // --- Persistence ---
        function saveState() { localStorage.setItem('pensionPlannerState', JSON.stringify(state)); }
        
        function loadState() {
            const saved = localStorage.getItem('pensionPlannerState');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    state = { ...defaultState, ...parsed, tax: { ...defaultState.tax, ...parsed.tax } };
                } catch (e) { console.error(e); }
            }
        }

        function clearStorage() {
            if(confirm("Are you sure you want to reset all data?")) {
                localStorage.removeItem('pensionPlannerState');
                state = JSON.parse(JSON.stringify(defaultState));
                syncInputsToState();
                renderPots();
                updateUI();
            }
        }

        // --- Tax Engine ---
        function calculateTax(grossPensionWithdrawal, statePensionGross) {
            // Apply 25% tax free rule to private pension part
            const taxFreeCash = grossPensionWithdrawal * (state.tax.taxFreeCashPercent / 100);
            const taxablePensionDraw = grossPensionWithdrawal - taxFreeCash;
            const totalTaxable = taxablePensionDraw + statePensionGross;
            
            let tax = 0;
            let remainder = totalTaxable - state.tax.allowance;
            
            if (remainder > 0) {
                const basicBandSize = state.tax.higherThreshold - state.tax.allowance;
                const taxableAtBasic = Math.min(remainder, basicBandSize);
                tax += taxableAtBasic * (state.tax.basicRate / 100);
                remainder -= taxableAtBasic;
            }
            
            if (remainder > 0) {
                tax += remainder * (state.tax.higherRate / 100);
            }
            
            return tax;
        }

        // --- Simulation Engine ---
        function runSimulation(params = {}) {
            const s = { ...state, ...params };
            const pots = s.pots.map(p => ({ ...p }));
            const currentPots = pots.map(p => ({ ...p, balance: p.value }));
            const simYears = s.lifeExpectancy - s.currentAge;
            const results = [];

            for (let i = 0; i <= simYears; i++) {
                const age = s.currentAge + i;
                const isRetired = age >= s.retireAge;
                const netTarget = isRetired ? s.targetIncome : 0;
                const grossSP = (s.statePension.active && age >= s.statePension.startAge) ? s.statePension.amount : 0;
                
                // Filter available pots
                const accessible = currentPots.filter(p => (p.accessAge === 0 || age >= p.accessAge) && p.balance > 0.01);
                const totalWealth = accessible.reduce((sum, p) => sum + p.balance, 0);
                
                let grossDraw = 0;
                let taxPaid = 0;
                let netReceived = 0;
                let shortfall = 0;

                if (isRetired) {
                    if (totalWealth <= 1) {
                        // Out of money
                        const tax = calculateTax(0, grossSP);
                        netReceived = grossSP - tax;
                        taxPaid = tax;
                        shortfall = Math.max(0, netTarget - netReceived);
                    } else {
                        // Binary Search for required Gross Draw to meet Net Target
                        let low = 0, high = totalWealth;
                        let bestGross = 0;

                        // Calc ratios (Pension vs ISA) to distribute draw
                        const penSum = accessible.filter(p => p.type === 'pension').reduce((s,p) => s+p.balance, 0);
                        const totalAcc = Math.max(1, totalWealth);
                        const penRatio = penSum / totalAcc;
                        const isaRatio = 1 - penRatio;

                        for(let k=0; k<10; k++) {
                            let guess = (low + high) / 2;
                            let gPen = guess * penRatio;
                            let gIsa = guess * isaRatio;
                            let tax = calculateTax(gPen, grossSP);
                            let net = (gPen + grossSP - tax) + gIsa;
                            
                            if (net < netTarget) low = guess;
                            else { high = guess; bestGross = guess; }
                        }
                        
                        // Cap at max wealth
                        if (bestGross > totalWealth) bestGross = totalWealth;

                        grossDraw = bestGross;
                        const pDraw = grossDraw * penRatio;
                        const iDraw = grossDraw * isaRatio;
                        taxPaid = calculateTax(pDraw, grossSP);
                        netReceived = (pDraw + grossSP - taxPaid) + iDraw;
                        shortfall = Math.max(0, netTarget - netReceived);

                        // Apply Drawdown to Pots
                        accessible.forEach(p => {
                            let share = p.balance / totalWealth;
                            let amt = grossDraw * share;
                            if(amt > p.balance) amt = p.balance;
                            p.balance -= amt;
                        });
                    }
                }

                // Growth & Contributions
                let yearEndTotal = 0;
                let balances = {};
                currentPots.forEach(p => {
                    if (age < p.stopAge) p.balance += (p.monthly * 12);
                    let realRate = (1 + p.growth/100) / (1 + s.inflationRate/100) - 1;
                    p.balance *= (1 + realRate);
                    if(p.balance < 0) p.balance = 0;
                    yearEndTotal += p.balance;
                    balances[p.id] = p.balance;
                });

                results.push({
                    age,
                    totalWealth: yearEndTotal,
                    netTarget,
                    grossDraw,
                    taxPaid,
                    netReceived,
                    shortfall,
                    potBalances: balances,
                    grossSP
                });
            }
            return results;
        }

        // --- Solvers ---
        function findEarliestRetirement() {
            for (let r = state.currentAge; r < state.lifeExpectancy; r++) {
                const testPots = state.pots.map(p => ({...p, stopAge: (p.stopAge === state.retireAge ? r : p.stopAge)}));
                const res = runSimulation({ retireAge: r, pots: testPots });
                // Consider failure if shortfall > £100/yr
                if (!res.some(d => d.age >= r && d.shortfall > 100)) return r;
            }
            return null;
        }

        function findMaxSustainableIncome() {
            let low = 0, high = 500000, best = 0;
            for(let i=0; i<12; i++) {
                let mid = (low+high)/2;
                const res = runSimulation({ targetIncome: mid });
                if (!res.some(d => d.age >= state.retireAge && d.shortfall > 100)) { best = mid; low = mid; }
                else high = mid;
            }
            return best;
        }

        // --- UI Logic ---
        function updateUI() {
            const data = runSimulation();
            
            // Update KPIs
            const rIdx = Math.max(0, state.retireAge - state.currentAge);
            const rData = data[rIdx] || { totalWealth: 0 };
            document.getElementById('kpiTotalValue').innerText = formatMoney(rData.totalWealth);

            const fail = data.find(d => d.age >= state.retireAge && d.shortfall > 100);
            const failAge = fail ? fail.age : `${state.lifeExpectancy}+`;
            document.getElementById('kpiRunOutAge').innerText = failAge;
            
            const kpiCard = document.getElementById('kpiStatusCard');
            const kpiText = document.getElementById('kpiStatusText');
            if(!fail) {
                kpiCard.className = "bg-emerald-50 p-3 sm:p-4 rounded-xl shadow-sm border border-emerald-200";
                document.getElementById('kpiRunOutAge').className = "text-lg sm:text-2xl font-bold text-emerald-600 mt-1 truncate";
                kpiText.innerText = "Fully Funded";
            } else {
                kpiCard.className = "bg-red-50 p-3 sm:p-4 rounded-xl shadow-sm border border-red-200";
                document.getElementById('kpiRunOutAge').className = "text-lg sm:text-2xl font-bold text-red-600 mt-1 truncate";
                kpiText.innerText = "Gap Starts";
            }

            document.getElementById('kpiEarliestAge').innerText = findEarliestRetirement() || "Never";
            document.getElementById('kpiMaxIncome').innerText = formatMoney(findMaxSustainableIncome());

            renderWealthChart(data);
            renderIncomeChart(data);
            renderScheduleTable(data);
            saveState();
        }

        function renderWealthChart(data) {
            const ctx = document.getElementById('wealthChart').getContext('2d');
            if (wealthChartInstance) wealthChartInstance.destroy();
            
            const datasets = state.pots.map((pot, i) => ({
                label: pot.name,
                data: data.map(d => d.potBalances[pot.id]),
                borderColor: COLORS[i%COLORS.length].border,
                backgroundColor: COLORS[i%COLORS.length].bg,
                fill: true, tension: 0.4, pointRadius: 0, borderWidth: 1
            }));
            
            wealthChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: data.map(d=>d.age), datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' }, tooltip: { mode: 'index', intersect: false } },
                    scales: { x: { grid: { display: false } }, y: { stacked: true, ticks: { callback: v=>'£'+v/1000+'k' } } }
                }
            });
        }

        function renderIncomeChart(data) {
            const ctx = document.getElementById('incomeChart').getContext('2d');
            if (incomeChartInstance) incomeChartInstance.destroy();
            
            const view = data.filter(d => d.age >= state.retireAge - 2);
            
            incomeChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: view.map(d=>d.age),
                    datasets: [
                        { type: 'line', label: 'Net Target', data: view.map(d=>d.netTarget), borderColor: '#374151', borderDash: [5,5], borderWidth: 2, pointRadius: 0 },
                        { label: 'Tax Paid', data: view.map(d=>d.taxPaid), backgroundColor: '#F59E0B' },
                        { label: 'Net Income', data: view.map(d=>d.netReceived), backgroundColor: '#10B981' },
                        { label: 'Gap', data: view.map(d=>d.shortfall), backgroundColor: '#EF4444' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    scales: { x: { stacked: true, grid: { display: false } }, y: { stacked: true } }
                }
            });
        }

        function renderScheduleTable(data) {
            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '';
            const fmt = n => new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', maximumFractionDigits: 0 }).format(n);
            
            data.forEach(d => {
                if (d.age < state.retireAge && d.age !== state.currentAge && d.age % 5 !== 0) return;
                const tr = document.createElement('tr');
                if (d.age === state.retireAge) tr.className = "bg-blue-50 font-bold";
                if (d.shortfall > 100) tr.className = "bg-red-50";
                tr.innerHTML = `
                    <td class="px-4 py-2 sticky left-0 bg-inherit border-r">${d.age}</td>
                    <td class="px-4 py-2 text-right text-gray-600">${fmt(d.totalWealth)}</td>
                    <td class="px-4 py-2 text-right text-gray-800">${d.age >= state.retireAge ? fmt(d.netTarget) : '-'}</td>
                    <td class="px-4 py-2 text-right text-red-500">${d.taxPaid > 0 ? fmt(d.taxPaid) : '-'}</td>
                    <td class="px-4 py-2 text-right text-gray-500">${d.grossDraw > 0 ? fmt(d.grossDraw) : '-'}</td>
                    <td class="px-4 py-2 text-right ${d.shortfall>100?'text-red-600 font-bold':'text-gray-300'}">${d.shortfall>100 ? fmt(d.shortfall) : '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- DOM Interactions ---
        function formatMoney(n) { return new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', maximumFractionDigits: 0 }).format(n); }
        
        function syncInputsToState() {
            document.getElementById('currentAge').value = state.currentAge;
            document.getElementById('retireAge').value = state.retireAge;
            document.getElementById('lifeExpectancy').value = state.lifeExpectancy;
            document.getElementById('targetIncome').value = state.targetIncome;
            document.getElementById('inflationRate').value = state.inflationRate;
            document.getElementById('includeStatePension').checked = state.statePension.active;
            document.getElementById('statePensionAge').value = state.statePension.startAge;
            document.getElementById('taxAllowance').value = state.tax.allowance;
            document.getElementById('taxBasicRate').value = state.tax.basicRate;
            document.getElementById('taxHigherThreshold').value = state.tax.higherThreshold;
            document.getElementById('taxHigherRate').value = state.tax.higherRate;
            document.getElementById('taxFreeCashPercent').value = state.tax.taxFreeCashPercent;
        }

        function switchTab(tabId) {
            ['wealth', 'income', 'schedule'].forEach(t => {
                document.getElementById(`view-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).classList.remove('border-blue-500', 'text-blue-600');
                document.getElementById(`tab-${t}`).classList.add('border-transparent', 'text-gray-500');
            });
            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            document.getElementById(`tab-${tabId}`).classList.add('border-blue-500', 'text-blue-600');
            document.getElementById(`tab-${tabId}`).classList.remove('border-transparent', 'text-gray-500');
        }

        function addPot(type) {
            const def = { pension: { n:'Pension', g:5, acc:57 }, isa: { n:'S&S ISA', g:6, acc:0 }, cash: { n:'Savings', g:2, acc:0 } }[type];
            state.pots.push({ id: 'p'+Date.now(), type, name: def.n, value: 0, monthly: 0, growth: def.g, accessAge: def.acc, stopAge: state.retireAge });
            renderPots(); updateUI();
        }

        function removePot(i) { state.pots.splice(i, 1); renderPots(); updateUI(); }
        
        function updatePot(i, f, v) { state.pots[i][f] = (f==='name')?v:parseFloat(v)||0; updateUI(); }

        function renderPots() {
            const c = document.getElementById('potsContainer'); c.innerHTML='';
            state.pots.forEach((p, i) => {
                const col = p.type==='pension'?'blue':p.type==='isa'?'purple':'emerald';
                c.innerHTML += `
                <div class="bg-white border border-${col}-100 rounded-lg p-3 shadow-sm group hover:border-${col}-300 transition">
                    <div class="flex justify-between mb-2 items-center">
                        <div class="flex items-center gap-2 w-full"><div class="w-2 h-2 rounded-full bg-${col}-500"></div><input value="${p.name}" onchange="updatePot(${i},'name',this.value)" class="font-semibold text-sm text-gray-800 w-2/3 border-none focus:ring-0 p-0"></div>
                        <button onclick="removePot(${i})" class="text-gray-300 hover:text-red-500">✕</button>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div><label class="text-[10px] text-gray-400 uppercase">Balance</label><input type="number" value="${p.value}" onchange="updatePot(${i},'value',this.value)" class="w-full text-sm bg-gray-50 border rounded px-1"></div>
                        <div><label class="text-[10px] text-gray-400 uppercase">Monthly</label><input type="number" value="${p.monthly}" onchange="updatePot(${i},'monthly',this.value)" class="w-full text-sm bg-gray-50 border rounded px-1"></div>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <div><label class="text-[10px] text-gray-400 uppercase">Growth%</label><input type="number" value="${p.growth}" step="0.1" onchange="updatePot(${i},'growth',this.value)" class="w-full text-sm text-green-600 font-medium bg-gray-50 border rounded px-1"></div>
                        <div><label class="text-[10px] text-gray-400 uppercase">Access</label><input type="number" value="${p.accessAge}" onchange="updatePot(${i},'accessAge',this.value)" class="w-full text-sm bg-gray-50 border rounded px-1"></div>
                        <div><label class="text-[10px] text-gray-400 uppercase">Stop</label><input type="number" value="${p.stopAge}" onchange="updatePot(${i},'stopAge',this.value)" class="w-full text-sm bg-gray-50 border rounded px-1"></div>
                    </div>
                </div>`;
            });
        }

        // --- Initialization & Listeners ---
        const map = { 'currentAge': 'currentAge', 'targetIncome': 'targetIncome', 'inflationRate': 'inflationRate', 'lifeExpectancy': 'lifeExpectancy' };
        Object.keys(map).forEach(id => document.getElementById(id).addEventListener('change', e => { state[map[id]] = parseFloat(e.target.value); updateUI(); }));

        document.getElementById('retireAge').addEventListener('change', e => {
            const val = parseFloat(e.target.value);
            state.retireAge = val;
            state.pots.forEach(p => p.stopAge = val);
            renderPots(); updateUI();
        });

        ['taxAllowance', 'taxBasicRate', 'taxHigherThreshold', 'taxHigherRate', 'taxFreeCashPercent'].forEach(id => {
            document.getElementById(id).addEventListener('change', e => {
                const key = id.replace('tax','').replace(/^\w/, c => c.toLowerCase());
                if(id === 'taxAllowance') state.tax.allowance = parseFloat(e.target.value);
                else if(id === 'taxBasicRate') state.tax.basicRate = parseFloat(e.target.value);
                else if(id === 'taxHigherThreshold') state.tax.higherThreshold = parseFloat(e.target.value);
                else if(id === 'taxHigherRate') state.tax.higherRate = parseFloat(e.target.value);
                else if(id === 'taxFreeCashPercent') state.tax.taxFreeCashPercent = parseFloat(e.target.value);
                updateUI();
            });
        });

        document.getElementById('includeStatePension').addEventListener('change', e => { state.statePension.active = e.target.checked; updateUI(); });
        document.getElementById('statePensionAge').addEventListener('change', e => { state.statePension.startAge = parseInt(e.target.value); updateUI(); });

        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        const toggle = () => { sidebar.classList.toggle('-translate-x-full'); overlay.classList.toggle('hidden'); };
        document.getElementById('mobileMenuBtn').onclick = toggle;
        document.getElementById('closeSidebar').onclick = toggle;
        overlay.onclick = toggle;

        loadState(); syncInputsToState(); renderPots(); updateUI();
    </script>
</body>
</html>