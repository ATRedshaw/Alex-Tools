<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alex's Pension Calculator</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        input[type="number"] { -moz-appearance: textfield; appearance: textfield; }
        input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        
        /* Chart height adjustments for mobile */
        .chart-container { position: relative; height: 300px; width: 100%; }
        @media (min-width: 768px) {
            .chart-container { height: 100%; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 flex flex-col h-screen overflow-hidden">

    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 flex-shrink-0 z-30 relative">
        <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-14">
                <div class="flex items-center gap-2">
                    <a href="index.html" class="flex items-center gap-2 hover:opacity-80 transition">
                        <div class="bg-blue-600 text-white p-1.5 rounded-lg">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                        </div>
                        <span class="text-lg font-bold text-gray-900 tracking-tight">Alex's <span class="text-blue-600">Pension Calculator</span></span>
                    </a>
                </div>
                
                <!-- Mobile Menu Button -->
                <button id="mobileMenuBtn" class="md:hidden p-2 text-gray-600 hover:text-blue-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
                </button>

                <div class="hidden md:block text-xs font-medium text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                    Real-Terms Projection (Today's Money)
                </div>
            </div>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
        
        <!-- Sidebar: Settings -->
        <aside id="sidebar" class="absolute md:static inset-0 z-20 bg-white transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col w-full md:w-[400px] lg:w-[450px] border-r border-gray-200 shadow-xl md:shadow-none">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center md:hidden bg-gray-50">
                <span class="font-bold text-gray-700">Configuration</span>
                <button id="closeSidebar" class="text-gray-500 p-1">✕ Close</button>
            </div>

            <div class="flex-1 overflow-y-auto custom-scroll p-5 space-y-6">
                
                <!-- Parameters -->
                <section class="space-y-4">
                    <h2 class="text-sm font-bold text-gray-900 uppercase tracking-wider flex items-center gap-2">
                        <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                        Personal
                    </h2>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="group">
                            <label class="block text-xs font-medium text-gray-500 mb-1">Current Age</label>
                            <input type="number" id="currentAge" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-md text-sm font-semibold focus:ring-2 focus:ring-blue-500 outline-none transition" value="35">
                        </div>
                        <div class="group">
                            <label class="block text-xs font-medium text-gray-500 mb-1">Retirement Age</label>
                            <input type="number" id="retireAge" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-md text-sm font-semibold focus:ring-2 focus:ring-blue-500 outline-none transition" value="60">
                        </div>
                        <div class="group">
                            <label class="block text-xs font-medium text-gray-500 mb-1">Life Expectancy</label>
                            <input type="number" id="lifeExpectancy" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-md text-sm font-semibold focus:ring-2 focus:ring-blue-500 outline-none transition" value="90">
                        </div>
                         <div class="group">
                            <label class="block text-xs font-medium text-gray-500 mb-1">Target Income (Net)</label>
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-gray-400 text-sm">£</span>
                                <input type="number" id="targetIncome" class="w-full pl-6 p-2 bg-gray-50 border border-gray-200 rounded-md text-sm font-semibold focus:ring-2 focus:ring-blue-500 outline-none transition" value="30000" step="500">
                            </div>
                        </div>
                    </div>

                    <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-xs font-medium text-gray-600">Inflation Rate</label>
                            <input type="number" id="inflationRate" value="2.5" step="0.1" class="w-16 text-right text-xs p-1 border border-gray-300 rounded bg-white">
                        </div>
                        <p class="text-[10px] text-gray-400">Calculations use Real Growth (Nominal - Inflation).</p>
                    </div>
                </section>

                <hr class="border-gray-100">

                <!-- Pots Manager -->
                <section class="space-y-4">
                    <div class="flex flex-col gap-2">
                        <h2 class="text-sm font-bold text-gray-900 uppercase tracking-wider flex items-center gap-2 mb-1">
                            <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            Funding Sources
                        </h2>
                        <!-- Quick Add Buttons -->
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="addPot('pension')" class="text-[10px] bg-blue-50 text-blue-700 border border-blue-200 px-2 py-1.5 rounded hover:bg-blue-100 transition font-medium text-center">
                                + Pension
                            </button>
                            <button onclick="addPot('isa')" class="text-[10px] bg-purple-50 text-purple-700 border border-purple-200 px-2 py-1.5 rounded hover:bg-purple-100 transition font-medium text-center">
                                + S&S ISA
                            </button>
                            <button onclick="addPot('cash')" class="text-[10px] bg-emerald-50 text-emerald-700 border border-emerald-200 px-2 py-1.5 rounded hover:bg-emerald-100 transition font-medium text-center">
                                + Cash
                            </button>
                        </div>
                    </div>

                    <div id="potsContainer" class="space-y-3">
                        <!-- Pots injected via JS -->
                    </div>
                    
                    <!-- State Pension -->
                    <div class="p-3 border border-gray-200 rounded-lg bg-indigo-50/50">
                        <div class="flex items-start gap-3">
                            <input type="checkbox" id="includeStatePension" checked class="mt-1 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                            <div class="flex-1">
                                <div class="flex justify-between">
                                    <label for="includeStatePension" class="text-sm font-semibold text-gray-800 cursor-pointer">UK State Pension</label>
                                    <span class="text-xs font-mono text-indigo-700">~£11,502/yr</span>
                                </div>
                                <div class="flex items-center gap-2 mt-1">
                                    <label class="text-[10px] text-gray-500">Claim Age:</label>
                                    <input type="number" id="statePensionAge" value="68" class="w-12 text-xs p-0.5 border rounded text-center bg-white">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="pt-4">
                        <button onclick="clearStorage()" class="w-full text-xs text-red-400 hover:text-red-600 underline text-center">Reset all data</button>
                    </div>
                </section>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden bg-gray-50 relative w-full">
            
            <!-- Real Terms Mobile Banner -->
            <div class="md:hidden bg-blue-50 border-b border-blue-100 px-4 py-2 text-center">
                <p class="text-xs font-medium text-blue-700">Figures in Real Terms (Today's Money)</p>
            </div>

            <!-- KPI Cards -->
            <div class="p-4 sm:p-6 grid grid-cols-2 lg:grid-cols-4 gap-3 flex-shrink-0">
                
                <!-- Value Card -->
                <div class="bg-white p-3 sm:p-4 rounded-xl shadow-sm border border-gray-200">
                    <p class="text-[10px] sm:text-xs font-medium text-gray-500 uppercase truncate">Pot @ Retirement</p>
                    <h3 class="text-lg sm:text-2xl font-bold text-gray-900 mt-1 truncate" id="kpiTotalValue">£0</h3>
                </div>

                <!-- Earliest Retirement Card -->
                <div class="bg-white p-3 sm:p-4 rounded-xl shadow-sm border border-gray-200 relative group">
                    <p class="text-[10px] sm:text-xs font-medium text-gray-500 uppercase truncate">Earliest Possible</p>
                    <h3 class="text-lg sm:text-2xl font-bold text-indigo-600 mt-1" id="kpiEarliestAge">--</h3>
                    <p class="text-[10px] text-gray-400">Age with 0 shortfall</p>
                    
                    <!-- Tooltip -->
                    <div class="absolute hidden group-hover:block top-full left-0 bg-gray-800 text-white text-xs p-2 rounded z-10 w-48 mt-1 shadow-lg">
                        The earliest age you can retire and sustain your target income until your life expectancy.
                    </div>
                </div>

                <!-- Max Sustainable Income -->
                <div class="bg-white p-3 sm:p-4 rounded-xl shadow-sm border border-gray-200 relative group">
                    <p class="text-[10px] sm:text-xs font-medium text-gray-500 uppercase truncate">Max Sustainable</p>
                    <h3 class="text-lg sm:text-2xl font-bold text-emerald-600 mt-1 truncate" id="kpiMaxIncome">£0</h3>
                    <p class="text-[10px] text-gray-400">Annual Income</p>
                    
                     <!-- Tooltip -->
                     <div class="absolute hidden group-hover:block top-full left-0 bg-gray-800 text-white text-xs p-2 rounded z-10 w-48 mt-1 shadow-lg">
                        The maximum flat income you can draw from your chosen retirement age until your life expectancy without running out.
                    </div>
                </div>

                <!-- Status Card -->
                <div class="bg-white p-3 sm:p-4 rounded-xl shadow-sm border border-gray-200" id="kpiStatusCard">
                    <p class="text-[10px] sm:text-xs font-medium text-gray-500 uppercase truncate">Funded Until</p>
                    <h3 class="text-lg sm:text-2xl font-bold text-gray-900 mt-1 truncate" id="kpiRunOutAge">95+</h3>
                    <p class="text-[10px] text-gray-400" id="kpiStatusText">Status</p>
                </div>
            </div>

            <!-- Tabs -->
            <div class="px-4 sm:px-6 border-b border-gray-200 bg-white flex-shrink-0 overflow-x-auto hide-scrollbar">
                <nav class="-mb-px flex space-x-6 sm:space-x-8">
                    <button onclick="switchTab('wealth')" id="tab-wealth" class="tab-btn border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">Wealth</button>
                    <button onclick="switchTab('income')" id="tab-income" class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">Income & Gap</button>
                    <button onclick="switchTab('schedule')" id="tab-schedule" class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">Schedule</button>
                </nav>
            </div>

            <!-- Tab Contents -->
            <div class="flex-1 overflow-y-auto custom-scroll p-4 sm:p-6">
                
                <!-- View: Wealth -->
                <div id="view-wealth" class="bg-white p-2 sm:p-4 rounded-xl border border-gray-200 shadow-sm h-full flex flex-col">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2">Total Pot Value (Real Terms)</h3>
                    <div class="flex-1 min-h-[300px] relative">
                        <canvas id="wealthChart"></canvas>
                    </div>
                </div>

                <!-- View: Income -->
                <div id="view-income" class="hidden bg-white p-2 sm:p-4 rounded-xl border border-gray-200 shadow-sm h-full flex flex-col">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2">Income Composition vs Target</h3>
                    <div class="flex-1 min-h-[300px] relative">
                        <canvas id="incomeChart"></canvas>
                    </div>
                </div>

                <!-- View: Schedule -->
                <div id="view-schedule" class="hidden bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50">Age</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Wealth</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Target</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">State Pen</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Private Draw</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Shortfall</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleBody" class="bg-white divide-y divide-gray-200 text-sm font-mono">
                                <!-- JS Injected -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Overlay for mobile sidebar -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-10 hidden md:hidden glass"></div>

    <script>
        /**
         * Pension Planner Pro - Core Logic
         */

        // --- Constants ---
        const COLORS = [
            { border: '#2563EB', bg: 'rgba(37, 99, 235, 0.6)' }, // Blue
            { border: '#059669', bg: 'rgba(5, 150, 105, 0.6)' }, // Emerald
            { border: '#7C3AED', bg: 'rgba(124, 58, 237, 0.6)' }, // Violet
            { border: '#D97706', bg: 'rgba(217, 119, 6, 0.6)' }, // Amber
            { border: '#DB2777', bg: 'rgba(219, 39, 119, 0.6)' }, // Pink
        ];

        // --- State Management ---
        const defaultState = {
            currentAge: 35,
            retireAge: 60,
            lifeExpectancy: 90,
            targetIncome: 30000,
            inflationRate: 2.5,
            statePension: {
                active: true,
                amount: 11502,
                startAge: 68
            },
            pots: [
                { id: 'p1', name: 'Workplace Pension', type:'pension', value: 45000, monthly: 400, growth: 5, accessAge: 57, stopAge: 60 },
                { id: 'p2', name: 'S&S ISA', type:'isa', value: 15000, monthly: 200, growth: 6, accessAge: 0, stopAge: 60 }
            ]
        };

        let state = JSON.parse(JSON.stringify(defaultState));
        let wealthChartInstance = null;
        let incomeChartInstance = null;

        // Persistence
        function saveState() {
            localStorage.setItem('pensionPlannerState', JSON.stringify(state));
        }

        function loadState() {
            const saved = localStorage.getItem('pensionPlannerState');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    // Merge carefully or just override if structure matches
                    state = { ...defaultState, ...parsed };
                    // Ensure deep copy integrity for arrays/objects if schema evolved (simplified here)
                } catch (e) {
                    console.error("Failed to load state", e);
                }
            }
        }

        function clearStorage() {
            if(confirm("Are you sure you want to reset all data?")) {
                localStorage.removeItem('pensionPlannerState');
                state = JSON.parse(JSON.stringify(defaultState));
                syncInputsToState();
                renderPots();
                updateUI();
            }
        }

        // --- Engine ---

        function runSimulation(params = {}) {
            const s = { ...state, ...params };
            const pots = s.pots.map(p => ({ ...p })); 
            const simYears = s.lifeExpectancy - s.currentAge;
            
            let results = [];
            let currentPots = pots.map(p => ({ ...p, balance: p.value }));

            for (let i = 0; i <= simYears; i++) {
                const age = s.currentAge + i;
                const isRetired = age >= s.retireAge;
                
                // 1. Income Requirements
                let incomeNeed = isRetired ? s.targetIncome : 0;
                let statePensionIncome = 0;
                if (s.statePension.active && age >= s.statePension.startAge) {
                    statePensionIncome = s.statePension.amount;
                }

                let neededFromPrivate = Math.max(0, incomeNeed - statePensionIncome);
                let drawnFromPrivate = 0;

                // 2. Drawdown
                if (neededFromPrivate > 0) {
                    const accessible = currentPots.filter(p => 
                        (p.accessAge === 0 || age >= p.accessAge) && p.balance > 0
                    );

                    if (accessible.length > 0) {
                        const totalAccessibleWealth = accessible.reduce((sum, p) => sum + p.balance, 0);
                        accessible.forEach(p => {
                            const share = p.balance / totalAccessibleWealth;
                            let amount = neededFromPrivate * share;
                            if (amount > p.balance) amount = p.balance;
                            p.balance -= amount;
                            drawnFromPrivate += amount;
                        });
                    }
                }

                const shortfall = Math.max(0, incomeNeed - (statePensionIncome + drawnFromPrivate));

                // 3. Growth & Contribution
                let yearTotalWealth = 0;
                let potSnapshots = {};

                currentPots.forEach(p => {
                    if (age < p.stopAge) {
                        p.balance += (p.monthly * 12);
                    }
                    const nominal = p.growth / 100;
                    const inflation = s.inflationRate / 100;
                    const realRate = (1 + nominal) / (1 + inflation) - 1;

                    p.balance = p.balance * (1 + realRate);
                    if (p.balance < 1) p.balance = 0;

                    yearTotalWealth += p.balance;
                    potSnapshots[p.id] = p.balance;
                });

                results.push({
                    age,
                    totalWealth: yearTotalWealth,
                    incomeTarget: incomeNeed,
                    statePension: statePensionIncome,
                    privateDrawdown: drawnFromPrivate,
                    shortfall: shortfall,
                    potBalances: potSnapshots
                });
            }
            return results;
        }

        function findEarliestRetirement() {
            const maxTestAge = state.lifeExpectancy - 1;
            for (let rAge = state.currentAge; rAge <= maxTestAge; rAge++) {
                const testPots = state.pots.map(p => ({
                    ...p,
                    // Sync logic: if stopAge == current retireAge, assume it moves with retirement
                    stopAge: (p.stopAge === state.retireAge) ? rAge : p.stopAge
                }));
                const res = runSimulation({ retireAge: rAge, pots: testPots, lifeExpectancy: state.lifeExpectancy });
                const hasShortfall = res.some(r => r.age >= rAge && r.shortfall > 100);
                if (!hasShortfall) return rAge;
            }
            return null;
        }

        function findMaxSustainableIncome() {
            let low = 0;
            let high = 500000; 
            let best = 0;
            for (let i = 0; i < 15; i++) { 
                let mid = (low + high) / 2;
                const res = runSimulation({ targetIncome: mid });
                const hasShortfall = res.some(r => r.age >= state.retireAge && r.shortfall > 100);
                if (!hasShortfall) { best = mid; low = mid; } else { high = mid; }
            }
            return best;
        }


        // --- Rendering & UI ---

        function updateUI() {
            const data = runSimulation();
            
            // KPI 1: Value at Retirement
            const retireIndex = Math.max(0, state.retireAge - state.currentAge);
            const valAtRetire = data[retireIndex] ? data[retireIndex].totalWealth : 0;
            document.getElementById('kpiTotalValue').innerText = formatMoney(valAtRetire);

            // KPI 2: Status
            const failYear = data.find(d => d.age >= state.retireAge && d.shortfall > 100);
            const failAge = failYear ? failYear.age : `${state.lifeExpectancy}+`;
            
            const kpiAgeEl = document.getElementById('kpiRunOutAge');
            const kpiStatusText = document.getElementById('kpiStatusText');
            
            kpiAgeEl.innerText = failAge;
            if (!failYear) {
                kpiAgeEl.className = "text-lg sm:text-2xl font-bold text-emerald-600 mt-1 truncate";
                kpiStatusText.innerText = "Fully Funded";
                document.getElementById('kpiStatusCard').className = "bg-emerald-50 p-3 sm:p-4 rounded-xl shadow-sm border border-emerald-200";
            } else {
                kpiAgeEl.className = "text-lg sm:text-2xl font-bold text-red-600 mt-1 truncate";
                kpiStatusText.innerText = `Gap starts at ${failAge}`;
                document.getElementById('kpiStatusCard').className = "bg-red-50 p-3 sm:p-4 rounded-xl shadow-sm border border-red-200";
            }

            // KPI 3 & 4
            const earlyAge = findEarliestRetirement();
            document.getElementById('kpiEarliestAge').innerText = earlyAge ? earlyAge : "Never";

            const maxInc = findMaxSustainableIncome();
            document.getElementById('kpiMaxIncome').innerText = formatMoney(maxInc);

            // Visuals
            renderWealthChart(data);
            renderIncomeChart(data);
            renderScheduleTable(data);
            
            // Persist
            saveState();
        }

        function renderWealthChart(data) {
            const ctx = document.getElementById('wealthChart').getContext('2d');
            if (wealthChartInstance) wealthChartInstance.destroy();

            const datasets = state.pots.map((pot, index) => {
                const color = COLORS[index % COLORS.length];
                return {
                    label: pot.name,
                    data: data.map(d => d.potBalances[pot.id]),
                    borderColor: color.border,
                    backgroundColor: color.bg,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0,
                    borderWidth: 1
                };
            });

            wealthChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: data.map(d => d.age), datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'nearest', axis: 'x', intersect: false },
                    plugins: {
                        tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: £${Math.round(ctx.raw).toLocaleString()}` } },
                        legend: { display: true, position: 'bottom' }
                    },
                    scales: {
                        x: { grid: { display: false } },
                        y: { stacked: true, ticks: { callback: v => '£' + (v/1000) + 'k' } }
                    }
                }
            });
        }

        function renderIncomeChart(data) {
            const ctx = document.getElementById('incomeChart').getContext('2d');
            if (incomeChartInstance) incomeChartInstance.destroy();

            const startIndex = Math.max(0, state.retireAge - state.currentAge - 5);
            const viewData = data.slice(startIndex);
            const labels = viewData.map(d => d.age);

            incomeChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { type: 'line', label: 'Target', data: viewData.map(d => d.incomeTarget), borderColor: '#374151', borderWidth: 2, borderDash: [5, 5], pointRadius: 0, order: 0 },
                        { label: 'Shortfall', data: viewData.map(d => d.shortfall), backgroundColor: '#EF4444', stack: 's1', order: 1 },
                        { label: 'State Pension', data: viewData.map(d => d.statePension), backgroundColor: '#6366F1', stack: 's1', order: 2 },
                        { label: 'Private Pots', data: viewData.map(d => d.privateDrawdown), backgroundColor: '#10B981', stack: 's1', order: 3 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true, grid: { display: false } },
                        y: { stacked: true, ticks: { callback: v => '£' + (v/1000) + 'k' } }
                    },
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        function renderScheduleTable(data) {
            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '';
            const fmt = n => new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', maximumFractionDigits: 0 }).format(n);

            data.forEach(d => {
                if (d.age < state.retireAge && d.age !== state.currentAge && d.age % 5 !== 0) return;
                const tr = document.createElement('tr');
                if (d.age === state.retireAge) tr.className = "bg-blue-50 font-semibold";
                if (d.shortfall > 100) tr.className = "bg-red-50";

                tr.innerHTML = `
                    <td class="px-4 py-2 whitespace-nowrap sticky left-0 ${d.shortfall > 100 ? 'bg-red-50' : (d.age === state.retireAge ? 'bg-blue-50' : 'bg-white')} z-10 border-r border-gray-100">${d.age}</td>
                    <td class="px-4 py-2 text-right text-gray-600 whitespace-nowrap">${fmt(d.totalWealth)}</td>
                    <td class="px-4 py-2 text-right text-gray-500 whitespace-nowrap">${d.age >= state.retireAge ? fmt(d.incomeTarget) : '-'}</td>
                    <td class="px-4 py-2 text-right text-indigo-600 whitespace-nowrap">${d.statePension > 0 ? fmt(d.statePension) : '-'}</td>
                    <td class="px-4 py-2 text-right text-emerald-600 whitespace-nowrap">${d.privateDrawdown > 0 ? fmt(d.privateDrawdown) : '-'}</td>
                    <td class="px-4 py-2 text-right font-bold whitespace-nowrap ${d.shortfall > 100 ? 'text-red-600' : 'text-gray-200'}">${d.shortfall > 100 ? fmt(d.shortfall) : '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- Helpers ---

        function formatMoney(amount) {
            return new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', maximumFractionDigits: 0 }).format(amount);
        }

        function addPot(type) {
            const defaultStop = state.retireAge;
            const defaults = {
                pension: { name: 'Pension', growth: 5, accessAge: 57, stopAge: defaultStop },
                isa: { name: 'S&S ISA', growth: 6, accessAge: 0, stopAge: defaultStop },
                cash: { name: 'Savings', growth: 2, accessAge: 0, stopAge: defaultStop }
            };
            const def = defaults[type] || defaults.cash;
            state.pots.push({
                id: 'pot-' + Date.now(),
                type: type,
                name: def.name,
                value: 0,
                monthly: 0,
                growth: def.growth,
                accessAge: def.accessAge,
                stopAge: def.stopAge
            });
            renderPots();
            updateUI();
        }

        function removePot(idx) {
            state.pots.splice(idx, 1);
            renderPots();
            updateUI();
        }

        function updatePot(idx, field, val) {
            if (field !== 'name') val = parseFloat(val) || 0;
            state.pots[idx][field] = val;
            updateUI();
        }

        function renderPots() {
            const container = document.getElementById('potsContainer');
            container.innerHTML = '';
            
            state.pots.forEach((pot, idx) => {
                const div = document.createElement('div');
                let accentColor = 'gray';
                if(pot.type === 'pension') accentColor = 'blue';
                else if(pot.type === 'isa') accentColor = 'purple';
                else if(pot.type === 'cash') accentColor = 'emerald';

                div.className = `bg-white border border-${accentColor}-100 rounded-lg p-3 shadow-sm relative group hover:border-${accentColor}-300 transition`;
                div.innerHTML = `
                    <div class="flex justify-between mb-2 items-center">
                        <div class="flex items-center gap-2 w-full">
                            <div class="w-2 h-2 rounded-full bg-${accentColor}-500"></div>
                            <input type="text" value="${pot.name}" onchange="updatePot(${idx}, 'name', this.value)" class="font-semibold text-sm text-gray-800 border-b border-transparent hover:border-gray-300 focus:border-blue-500 focus:outline-none w-2/3 bg-transparent">
                        </div>
                        <button onclick="removePot(${idx})" class="text-gray-300 hover:text-red-500"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div>
                            <label class="block text-[10px] text-gray-400 uppercase">Balance (£)</label>
                            <input type="number" value="${pot.value}" onchange="updatePot(${idx}, 'value', this.value)" class="w-full text-sm bg-gray-50 border rounded px-1 py-0.5">
                        </div>
                        <div>
                            <label class="block text-[10px] text-gray-400 uppercase">Monthly (£)</label>
                            <input type="number" value="${pot.monthly}" onchange="updatePot(${idx}, 'monthly', this.value)" class="w-full text-sm bg-gray-50 border rounded px-1 py-0.5">
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <div>
                            <label class="block text-[10px] text-gray-400 uppercase">Growth %</label>
                            <input type="number" value="${pot.growth}" step="0.1" onchange="updatePot(${idx}, 'growth', this.value)" class="w-full text-sm text-green-600 font-medium bg-gray-50 border rounded px-1 py-0.5">
                        </div>
                        <div>
                            <label class="block text-[10px] text-gray-400 uppercase" title="Minimum Access Age">Access @</label>
                            <input type="number" value="${pot.accessAge}" onchange="updatePot(${idx}, 'accessAge', this.value)" class="w-full text-sm bg-gray-50 border rounded px-1 py-0.5">
                        </div>
                        <div>
                            <label class="block text-[10px] text-gray-400 uppercase" title="Age contributions stop">Stop @</label>
                            <input type="number" value="${pot.stopAge}" onchange="updatePot(${idx}, 'stopAge', this.value)" class="w-full text-sm bg-gray-50 border rounded px-1 py-0.5">
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function switchTab(tabId) {
            ['wealth', 'income', 'schedule'].forEach(t => {
                document.getElementById(`view-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).classList.remove('border-blue-500', 'text-blue-600');
                document.getElementById(`tab-${t}`).classList.add('border-transparent', 'text-gray-500');
            });
            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            document.getElementById(`tab-${tabId}`).classList.add('border-blue-500', 'text-blue-600');
            document.getElementById(`tab-${tabId}`).classList.remove('border-transparent', 'text-gray-500');
        }

        function syncInputsToState() {
            document.getElementById('currentAge').value = state.currentAge;
            document.getElementById('retireAge').value = state.retireAge;
            document.getElementById('lifeExpectancy').value = state.lifeExpectancy;
            document.getElementById('targetIncome').value = state.targetIncome;
            document.getElementById('inflationRate').value = state.inflationRate;
            document.getElementById('includeStatePension').checked = state.statePension.active;
            document.getElementById('statePensionAge').value = state.statePension.startAge;
        }

        // --- Init & Listeners ---
        
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        
        function toggleSidebar() {
            const isClosed = sidebar.classList.contains('-translate-x-full');
            if (isClosed) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        document.getElementById('mobileMenuBtn').addEventListener('click', toggleSidebar);
        document.getElementById('closeSidebar').addEventListener('click', toggleSidebar);
        overlay.addEventListener('click', toggleSidebar);

        // Bind Inputs
        const map = {
            'currentAge': 'currentAge',
            'targetIncome': 'targetIncome',
            'inflationRate': 'inflationRate',
            'lifeExpectancy': 'lifeExpectancy'
        };
        
        Object.keys(map).forEach(id => {
            document.getElementById(id).addEventListener('change', (e) => {
                state[map[id]] = parseFloat(e.target.value);
                updateUI();
            });
        });

        // Special listener for retireAge to sync stopAges
        document.getElementById('retireAge').addEventListener('change', (e) => {
            const newAge = parseFloat(e.target.value);
            state.retireAge = newAge;
            
            // Bulk update stop ages to match new retirement age
            state.pots.forEach(pot => {
                pot.stopAge = newAge;
            });
            
            renderPots(); // Update DOM inputs
            updateUI();
        });

        document.getElementById('includeStatePension').addEventListener('change', (e) => {
            state.statePension.active = e.target.checked;
            updateUI();
        });
        document.getElementById('statePensionAge').addEventListener('change', (e) => {
            state.statePension.startAge = parseInt(e.target.value);
            updateUI();
        });

        // Load & Init
        loadState();
        syncInputsToState();
        renderPots();
        updateUI();

    </script>
</body>
</html>